
<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <title>Officer Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    body {
      font-family: 'Krasar', Arial, sans-serif;
      background-color: #1c2331;
      color: white;
      margin: 0;
      padding-top: 60px;
    }
    .header {
      background-color: #0d2d5c;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      z-index: 1000;
    }
    .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 12px;
      margin-right: 8px;
      border-radius: 6px;
    }
    .back-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .header-title {
      flex: 1;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      margin-left: -20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-box input {
      width: 160px;
      padding: 6px 12px;
      border-radius: 18px;
      border: none;
      font-size: 15px;
      font-family: 'Krasar', sans-serif;
    }
    .section {
      background: white;
      color: black;
      margin: 14px auto;
      max-width: 700px;
      padding: 10px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .form-section {
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }
    .image-preview {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .image-preview img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid #ccc;
      background: #f0f0f0;
      margin-bottom: 6px;
    }
    .image-preview input[type="file"] {
      font-size: 11px;
      width: 100px;
    }
    .form-fields {
      flex: 1;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 2px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Krasar', Arial;
      box-sizing: border-box;
    }
    .button-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 12px;
    }
    .button-row button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button {
      padding: 10px;
      background-color: #0d2d5c;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
    }
    button:hover {
      background-color: #09306d;
    }
    .icon-btn {
      width: 18px;
      height: 18px;
    }
    .table-wrapper {
      overflow-x: auto;
      width: 100%;
      border-radius: 8px;
    }
    table {
      min-width: 700px;
      width: max-content;
      border-collapse: collapse;
      margin-top: 10px;
      text-align: center;
      font-size: 12px;
    }
    th, td {
      padding: 4px 6px;
      border: 1px solid #ccc;
      white-space: nowrap;
    }
    th {
      background-color: #0d2d5c;
      color: white;
    }
    .table-wrapper::-webkit-scrollbar {
      height: 8px;
    }
    .table-wrapper::-webkit-scrollbar-track {
      background: #e0e0e0;
      border-radius: 10px;
    }
    .table-wrapper::-webkit-scrollbar-thumb {
      background-color: #0d2d5c;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
    }
    .selected-row {
      background-color: #ffd700;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="back-btn" onclick="window.location.href='adminupload.html'">‚Üê</button>
    <span class="header-title">·ûî·ûâ·üí·ûú·ûº·ûõ·ûê·üí·ûò·û∏ ·ûì·û∑·ûÑ·ûÄ·üÇ·ûî·üí·ûö·üÇ·ûó·üí·ûì·û∂·ûÄ·üã·ûÑ·û∂·ûö</span>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûó·üí·ûì·û∂·ûÄ·üã·ûÑ·û∂·ûö·û•·ûé·ûë·û∂·ûì" />
    </div>
  </div>
  <div class="section form-section">
    <div class="image-preview">
      <img id="previewImage" src="../icons/default-user.png" alt="Preview" />
      <input type="file" id="uploadImage" accept="image/*" onchange="uploadToServer()" />
    </div>
    <div class="form-fields">
      <input type="text" id="username" placeholder="Username" oninput="autoFillImagePath()">
      <input type="password" id="password" placeholder="Password">
      <input type="text" id="position" placeholder="Position">
      <input type="text" id="fullname" placeholder="Fullname">
      <input type="text" id="phone" placeholder="Phone">
      <input type="text" id="branch" placeholder="Branch">
      <input type="text" id="image" placeholder="Image Path" oninput="updatePreview()" />
      <div class="button-row">
        <button id="addBtn" onclick="addOrUpdateOfficer()">
          <img src="../icons/add-newSP.png" class="icon-btn" alt="Add"> Save
        </button>
        <button onclick="clearForm()">
          <img src="../icons/editSP.png" class="icon-btn" alt="Clear"> Clear
        </button>
        <button onclick="deleteOfficer()">
          <img src="../icons/deleteSP.png" class="icon-btn" alt="Delete"> Delete
        </button>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="table-wrapper">
      <table id="officerTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Password</th>
            <th>Position</th>
            <th>Fullname</th>
            <th>Phone</th>
            <th>Branch</th>
            <th>Image Path</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let selectedUsername = null;

    function autoFillImagePath() {
      const username = document.getElementById("username").value.trim();
      if (username) {
        document.getElementById("image").value = "profile/" + username + ".jpg";
        updatePreview();
      }
    }

  
function updatePreview() {
  const path = document.getElementById("image").value.trim();
  const preview = document.getElementById("previewImage");

  if (!path) {
    preview.src = "../icons/non-image.jpg";
  } else if (path.startsWith("http")) {
    preview.src = path;
  } else {
    preview.src = `https://secure-backend-tzj9.onrender.com/${path}`;
  }
}



async function uploadToServer() {
  const fileInput = document.getElementById("uploadImage");
  const file = fileInput.files[0];
  if (!file) return;

  const token = sessionStorage.getItem("token");
  if (!token) {
    alert("Session expired. Please log in again.");
    return;
  }

  const formData = new FormData();
  formData.append("image", file);

  try {
    const res = await fetch("https://secure-backend-tzj9.onrender.com/api/upload", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData
    });

    const result = await res.json();
    console.log("‚úÖ Upload result:", result);

    if (res.ok && result.imageUrl) {
      document.getElementById("image").value = result.imageUrl; // full path like 'profile/123.jpg'
      updatePreview(); // immediately show new preview
    } else {
      alert("Upload failed: " + (result.message || "Unknown error"));
    }
  } catch (err) {
    console.error("‚ùå Upload error:", err);
    alert("Failed to upload image.");
  }
}

    async function fetchOfficers() {
  const token = sessionStorage.getItem("token");
  const tbody = document.querySelector("#officerTable tbody");

  if (!token) {
    console.error("‚ùå No token found in sessionStorage");
    alert("Session expired. Please log in again.");
    return;
  }

  try {
    const res = await fetch("https://secure-backend-tzj9.onrender.com/api/users", {
      headers: { Authorization: `Bearer ${token}` }
    });

    console.log("üì° Response status:", res.status);
    const result = await res.json();
    console.log("üì¶ Officers result:", result);

    if (!res.ok) {
      alert(result.message || "Failed to load officers");
      return;
    }

    const officers = result;
    tbody.innerHTML = "";

    if (!Array.isArray(officers) || officers.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7">‚ö†Ô∏è No officer data found</td></tr>`;
      return;
    }

    officers.forEach(user => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.username}</td>
        <td>${user.password}</td>
        <td>${user.position}</td>
        <td>${user.fullname}</td>
        <td>${user.phone}</td>
        <td>${user.branch}</td>
        <td>${user.image}</td>
      `;
      tr.onclick = () => selectRow(tr, user);
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("‚ùå Fetch error:", err);
    alert("Error connecting to server. Please check your internet.");
  }
}

    function selectRow(row, user) {
      document.querySelectorAll("#officerTable tbody tr").forEach(r => r.classList.remove("selected-row"));
      row.classList.add("selected-row");

      selectedUsername = user.username;
      document.getElementById("username").value = user.username;
      document.getElementById("password").value = user.password;
      document.getElementById("position").value = user.position;
      document.getElementById("fullname").value = user.fullname;
      document.getElementById("phone").value = user.phone;
      document.getElementById("branch").value = user.branch;
      document.getElementById("image").value = user.image;
      document.getElementById("addBtn").innerHTML = `<img src="../icons/add-newSP.png" class="icon-btn"> Update`;
      updatePreview();
    }

    async function addOrUpdateOfficer() {
      const token = sessionStorage.getItem("token");
      const data = {
        username: document.getElementById("username").value.trim(),
        password: document.getElementById("password").value.trim(),
        position: document.getElementById("position").value.trim(),
        fullname: document.getElementById("fullname").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        branch: document.getElementById("branch").value.trim(),
        image: document.getElementById("image").value.trim()
      };

      if (!data.username) return alert("Username is required");

      const res = await fetch("https://secure-backend-tzj9.onrender.com/api/users", {
        method: selectedUsername ? "PUT" : "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (res.ok) {
        alert(result.message);
        clearForm();
        fetchOfficers();
      } else {
        alert(result.message || "Error saving officer");
      }
    }

    async function deleteOfficer() {
      if (!selectedUsername) return alert("Select a row to delete");
      const confirmDelete = confirm("Are you sure to delete this officer?");
      if (!confirmDelete) return;
      const token = sessionStorage.getItem("token");

      const res = await fetch("https://secure-backend-tzj9.onrender.com/api/users/" + selectedUsername, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });

      const result = await res.json();
      if (res.ok) {
        alert(result.message);
        clearForm();
        fetchOfficers();
      } else {
        alert("Delete failed");
      }
    }

    function clearForm() {
      selectedUsername = null;
      document.querySelectorAll("input").forEach(i => i.value = "");
      document.getElementById("previewImage").src = "../icons/default-user.png";
      document.getElementById("addBtn").innerHTML = `<img src="../icons/add-newSP.png" class="icon-btn"> Save`;
    }

    document.addEventListener("DOMContentLoaded", fetchOfficers);
  </script>
</body>
</html>
