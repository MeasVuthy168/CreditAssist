<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>Setting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f5f7fb}
    header{background:#0d2d5c;color:#fff;padding:14px 16px;font-weight:700}
    .row{display:flex;justify-content:space-between;align-items:center;background:#fff;margin:12px;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .btn{background:#e9eefc;border:0;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    .panel{background:#0b1324;color:#bdf5c2;margin:12px;padding:14px;border-radius:12px}
    .btns{display:flex;gap:10px;margin-bottom:10px}
    .pill{background:#1f2a44;color:#d6e8ff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    pre{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <header>Setting</header>

  <div class="row">
    <div>‚úì <strong>Enabled</strong></div>
    <button id="enableBtn" class="btn">Enable Push</button>
  </div>

  <div class="panel">
    <div class="btns">
      <button id="localBtn" class="pill">‚úèÔ∏è Local SW test</button>
      <button id="serverBtn" class="pill">üß® Server test push</button>
      <button id="fixBtn" class="pill">üõ†Ô∏è Fix Push / Re-enable</button>
      <button id="envBtn" class="pill">üßæ Env info</button>
    </div>
    <pre id="log">[--] Debug panel ready</pre>
  </div>

<script>
const API_BASE = "https://secure-backend-tzj9.onrender.com";
const basePath = "/CreditAssist"; // GitHub Pages base path
const logEl = document.getElementById('log');
const token = () => sessionStorage.getItem('token') || '';

function log(line) {
  const ts = new Date().toTimeString().slice(0,8);
  logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
}

async function registerSW() {
  if (!('serviceWorker' in navigator)) throw new Error('SW not supported');
  const reg = await navigator.serviceWorker.register(`${basePath}/service-worker.js`, { scope: `${basePath}/` });
  if (!navigator.serviceWorker.controller) {
    log('SW installed but not controlling yet. Reload once.');
  }
  return reg;
}

function urlBase64ToUint8Array(b64) {
  const padding = '='.repeat((4 - (b64.length % 4)) % 4);
  const s = (b64 + padding).replace(/-/g, '+').replace(/_/g, '/');
  const raw = atob(s);
  const out = new Uint8Array(raw.length);
  for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
  return out;
}

async function getVapidKey() {
  const r = await fetch(`${API_BASE}/api/push/public-key`);
  const j = await r.json();
  if (!j.key) throw new Error('No VAPID key from server');
  return j.key;
}

async function enablePush() {
  try {
    if (!token()) { alert('Please login again (no JWT token).'); return; }

    const perm = await Notification.requestPermission();
    if (perm !== 'granted') { alert('Notification permission denied'); return; }

    const reg = await registerSW();
    const old = await reg.pushManager.getSubscription();
    if (old) await old.unsubscribe().catch(()=>{});

    const vapid = await getVapidKey();
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(vapid)
    });

    const resp = await fetch(`${API_BASE}/api/push/subscribe`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token()}` },
      body: JSON.stringify({ subscription: sub })
    });
    if (!resp.ok) {
      const t = await resp.text();
      throw new Error(`Backend ${resp.status}: ${t}`);
    }

    log('‚úÖ Subscribed and saved');
    alert('Push enabled!');
  } catch (e) {
    log(`subscribe error: ${e.message}`);
    alert(`Subscription failed: ${e.message}`);
  }
}

async function localTest() {
  try {
    const reg = await registerSW();
    const sub = await reg.pushManager.getSubscription();
    const scope = reg.scope;
    const endpoint = sub?.endpoint || '';
    log(`local test ‚Üí swScope=${scope} notifications=${Notification.permission} endpoint=${endpoint.slice(0,60)}`);
  } catch (e) {
    log(`local test error: ${e.message}`);
  }
}

async function serverTest() {
  try {
    // broadcast is more reliable for testing
    const r = await fetch(`${API_BASE}/api/push/notify-all`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token()}` }
    });
    const j = await r.json().catch(()=> ({}));
    log(`server test ‚Üí status=${r.status} sent=${j.sent ?? 'n/a'} failed=${j.failures ?? 'n/a'}`);
  } catch (e) {
    log(`server test error: ${e.message}`);
  }
}

async function envInfo() {
  try {
    const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
    const scope = reg?.scope || '(none)';
    const r = await fetch(`${API_BASE}/api/push/diag`, { headers: { 'Authorization': `Bearer ${token()}` }});
    const j = await r.json().catch(()=> ({}));
    log(`ENV ‚Üí origin=${location.origin}\nSW scope=${scope}\ndiag: total=${j.total} noEndpoint=${j.noEndpoint} invalid=${j.invalid} vapidLen=${j.vapidLen}\nsample=${j.sample?.endpoint || '(none)'}`);
  } catch (e) {
    log(`env error: ${e.message}`);
  }
}

async function fixPush() {
  try {
    // Unsubscribe all service worker subs for this scope, unregister SW, re-enable
    const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
    if (reg) {
      const sub = await reg.pushManager.getSubscription();
      if (sub) await sub.unsubscribe().catch(()=>{});
      await reg.unregister();
    }
    log('Cleared subscriptions and unregistered SW ‚Üí re-enabling‚Ä¶');
    await enablePush();
  } catch (e) {
    log(`Fix error: ${e.message}`);
  }
}

// Wire up buttons
document.getElementById('enableBtn').onclick = enablePush;
document.getElementById('localBtn').onclick = localTest;
document.getElementById('serverBtn').onclick = serverTest;
document.getElementById('envBtn').onclick = envInfo;
document.getElementById('fixBtn').onclick = fixPush;

// Log initial env
(async () => {
  const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
  log(`SW scope=${reg?.scope || '(none)'}`);
  log(`ENV ‚Üí origin=${location.origin}`);
})();
</script>
</body>
</html>
