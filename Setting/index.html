<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <title>Setting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    @font-face { font-family:'Krasar'; src:url('../Krasar-Regular.ttf') format('truetype'); }
    body{margin:0;font-family:'Krasar',Arial,sans-serif;background:#f1f4f8;color:#333;padding-bottom:72px}
    .header{background:#0d2d5c;color:#fff;padding:14px 16px;font-size:18px;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.2);position:fixed;top:0;left:0;right:0;z-index:2;display:flex;align-items:center}
    .header .back{font-size:22px;color:#fff;background:none;border:none;margin-right:12px;cursor:pointer}
    .section{margin-top:60px}
    .item{background:#fff;padding:16px;border-bottom:1px solid #ddd;display:flex;align-items:center;justify-content:space-between}
    .btn{background:#eef2f7;border:1px solid #cfd6df;border-radius:8px;padding:10px 14px;font-family:inherit;cursor:pointer}
    .btn.primary{background:#0d2d5c;color:#fff;border-color:#0d2d5c}
    .debug{margin:16px;background:#0e1320;color:#b7ffb7;border-radius:10px;padding:12px;font-family:ui-monospace,Consolas,monospace}
    .debug .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .debug .chip{background:#20314d;color:#e5f2ff;border:1px solid #395781;border-radius:10px;padding:8px 10px;cursor:pointer}
    .footer{position:fixed;bottom:0;left:0;right:0;height:56px;background:#0d2d5c}
  </style>
</head>
<body>
  <div class="header">
    <button class="back" onclick="location.href='../index.html'">‚Üê</button>
    <div>Setting</div>
  </div>

  <div class="section">
    <div class="item">
      <div id="pushState">‚úì Enabled</div>
      <button id="enableBtn" class="btn">Enable Push</button>
    </div>

    <div class="debug">
      <div style="font-weight:700;margin-bottom:8px">üîé Push Debug</div>
      <div class="row">
        <button class="chip" onclick="localTest()">‚úèÔ∏è Local SW test</button>
        <button class="chip" onclick="serverTest()">üß® Server test push</button>
        <button class="chip" onclick="fixPush()">üõ†Ô∏è Fix Push / Re-enable</button>
        <button class="chip" onclick="envInfo()">‚ÑπÔ∏è Env info</button>
      </div>
      <pre id="log" style="white-space:pre-wrap;margin:0"></pre>
    </div>
  </div>

  <div class="footer"></div>

  <script>
    // ===== Configuration =====
    const API_BASE = "https://secure-backend-tzj9.onrender.com";
    const basePath = "/CreditAssist"; // GitHub Pages subpath
    const token = sessionStorage.getItem('token') || '';
    const logEl = document.getElementById('log');

    function log(line){
      const ts = new Date().toTimeString().slice(0,8);
      logEl.textContent = `[${ts}] ${line}\n` + logEl.textContent;
    }

    // ===== Service Worker registration (scoped to /CreditAssist/) =====
    async function registerSW() {
      if (!('serviceWorker' in navigator)) throw new Error('SW not supported in this browser');
      const reg = await navigator.serviceWorker.register(`${basePath}/service-worker.js`, { scope: `${basePath}/` });
      if (!navigator.serviceWorker.controller) {
        log('SW installed; reload once to let it control this page.');
      }
      return reg;
    }

    // ===== Helpers =====
    function urlBase64ToUint8Array(base64String){
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const raw = atob(base64);
      const arr = new Uint8Array(raw.length);
      for (let i=0;i<raw.length;i++) arr[i] = raw.charCodeAt(i);
      return arr;
    }

    async function getVapidKey(){
      const r = await fetch(`${API_BASE}/api/push/public-key`);
      const j = await r.json();
      if (!j.key) throw new Error("No VAPID key from server");
      return j.key;
    }

    // ===== Enable / subscribe =====
    async function enablePush() {
      try {
        // Permission
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') { alert('Notification permission denied'); return; }

        // Register SW
        const reg = await registerSW();

        // Remove any stale subscription to avoid key mismatch
        const old = await reg.pushManager.getSubscription();
        if (old) { await old.unsubscribe().catch(()=>{}); }

        // Subscribe
        const vapid = await getVapidKey();
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapid)
        });

        // Serialize correctly (important!)
        const subJSON = (sub && typeof sub.toJSON === 'function') ? sub.toJSON() : sub;
        log(`subscribed endpoint=${subJSON && subJSON.endpoint ? subJSON.endpoint.slice(0, 48) : 'N/A'}`);

        if (!subJSON || !subJSON.endpoint) {
          throw new Error("Browser returned subscription without endpoint");
        }

        // Send to backend
        const resp = await fetch(`${API_BASE}/api/push/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ subscription: subJSON })
        });

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`Backend ${resp.status}: ${t}`);
        }

        document.getElementById('pushState').textContent = '‚úì Enabled';
        log('subscription saved on server');
        alert('Push enabled!');
      } catch (e) {
        console.error(e);
        log(`subscribe error: ${e.message}`);
        alert(`Subscription failed: ${e.message}`);
      }
    }

    // ===== Debug helpers =====
    async function localTest(){
      try{
        const reg = await registerSW();
        const sub = await reg.pushManager.getSubscription();
        const subJSON = sub && sub.toJSON ? sub.toJSON() : sub;
        const scope = (reg && reg.scope) || 'N/A';
        const ep = subJSON && subJSON.endpoint ? subJSON.endpoint : '';
        const notifPerm = (typeof Notification !== 'undefined') ? Notification.permission : 'n/a';
        log(`local test ‚Üí swScope=${scope} notifications=${notifPerm} endpoint=${ep ? ep.slice(0,48) : '(none)'}`);
      }catch(e){ log(`local test error: ${e.message}`); }
    }

    async function serverTest(){
      try{
        const r = await fetch(`${API_BASE}/api/push/notify-test`, {
          method:'POST',
          headers:{ 'Authorization': `Bearer ${token}` }
        });
        const j = await r.json().catch(()=> ({}));
        log(`server test ‚Üí status=${r.status} sent=${j.sent ?? 'n/a'} failed=${j.failures ?? 'n/a'}`);
      }catch(e){ log(`server test error: ${e.message}`); }
    }

    async function envInfo(){
      try{
        const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
        const scope = reg?.scope || '(none)';
        log(`ENV ‚Üí origin=${location.origin}\nSW scope=${scope}`);
        const d = await fetch(`${API_BASE}/api/push/diag`, { headers:{ 'Authorization': `Bearer ${token}` }}).then(r=>r.json());
        log(`diag: total=${d.total} noEndpoint=${d.noEndpoint} invalid=${d.invalid} vapidLen=${d.vapidPublicLen} sample=${d.sampleEndpoint || '(none)'}`);
      }catch(e){ log(`env error: ${e.message}`); }
    }

    async function fixPush(){
      try{
        const reg = await registerSW();
        const old = await reg.pushManager.getSubscription();
        if (old) { await old.unsubscribe().catch(()=>{}); }
        await reg.unregister();
        log('Cleared subscriptions and unregistered SW ‚Üí re-enabling‚Ä¶');
        setTimeout(enablePush, 600);
      }catch(e){ log(`Fix error: ${e.message}`); }
    }

    // Wire UI
    document.getElementById('enableBtn').addEventListener('click', enablePush);

    // Initial state
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
        const sub = await reg?.pushManager.getSubscription();
        if (sub) document.getElementById('pushState').textContent = '‚úì Enabled';
      } catch {}
      log('Debug panel ready');
    });
  </script>
</body>
</html>
