<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Setting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f5f7fb;color:#223}
    .bar{display:flex;justify-content:space-between;align-items:center;background:#0d2d5c;color:#fff;padding:14px 16px}
    .wrap{max-width:940px;margin:14px auto;padding:0 12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#e9eef8;border:1px solid #cfd9ee;border-radius:12px;padding:12px 14px;cursor:pointer}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{font-weight:600;color:#2a6;display:inline-flex;align-items:center;gap:8px}
    pre{background:#0b1220;color:#b7fca2;border-radius:12px;padding:14px;white-space:pre-wrap;word-break:break-word;min-height:120px}
  </style>
</head>
<body>
  <div class="bar"><strong>Setting</strong></div>
  <div class="wrap">

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">‚úî Enabled</div>
        <button id="enableBtn" class="btn">Enable Push</button>
      </div>
    </div>

    <div class="card">
      <h3>üîé Push Debug</h3>
      <div class="row" style="margin:8px 0 12px">
        <button id="localBtn" class="btn">‚úèÔ∏è Local SW test</button>
        <button id="serverBtn" class="btn">üéØ Server test push</button>
        <button id="fixBtn" class="btn">üõ†Ô∏è Fix Push / Re-enable</button>
        <button id="envBtn" class="btn">üßæ Env info</button>
      </div>
      <pre id="log">[--] Debug panel ready</pre>
    </div>

  </div>

<script>
const API_BASE = "https://secure-backend-tzj9.onrender.com";
const basePath = "/CreditAssist"; // GitHub Pages repo subpath

const logEl = document.getElementById('log');
function log(msg){ logEl.textContent += (logEl.textContent ? "\n" : "") + msg; logEl.scrollTop = logEl.scrollHeight; }
function token(){ return sessionStorage.getItem('token') || ""; }

async function registerSW() {
  if (!('serviceWorker' in navigator)) throw new Error('SW not supported');
  const reg = await navigator.serviceWorker.register(`${basePath}/service-worker.js`, { scope: `${basePath}/` });
  if (!navigator.serviceWorker.controller) {
    log('SW installed; please reload once so it controls this page.');
  }
  return reg;
}

async function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const raw = atob(base64); const out = new Uint8Array(raw.length);
  for (let i = 0; i < raw.length; ++i) out[i] = raw.charCodeAt(i);
  return out;
}

async function getVapidKey() {
  const r = await fetch(`${API_BASE}/api/push/public-key`);
  const j = await r.json();
  if (!j.key) throw new Error('No VAPID key from server');
  return j.key;
}

async function enablePush() {
  try {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') { alert('Notifications denied'); return; }

    const reg = await registerSW();

    // clean old sub
    const old = await reg.pushManager.getSubscription();
    if (old) await old.unsubscribe().catch(()=>{});

    const key = await getVapidKey();
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: await urlBase64ToUint8Array(key)
    });

    const resp = await fetch(`${API_BASE}/api/push/subscribe`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token()}` },
      body: JSON.stringify({ subscription: sub })
    });
    if (!resp.ok) {
      const t = await resp.text();
      throw new Error(`Backend ${resp.status}: ${t}`);
    }
    log('Subscribed successfully.');
  } catch (e) {
    log('subscribe error: ' + e.message);
    alert('Subscription failed: ' + e.message);
  }
}

async function serverTest() {
  try {
    const r = await fetch(`${API_BASE}/api/push/notify-test`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token()}` }
    });
    const j = await r.json();
    log(`server test ‚Üí status=${r.status} sent=${j.sent ?? 'n/a'} failed=${j.failed ?? 'n/a'} ${j.reason ? 'reason='+j.reason : ''}`);
  } catch (e) {
    log('server test error: ' + e.message);
  }
}

async function envInfo() {
  try {
    const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
    const scope = reg?.scope || '(none)';
    const r = await fetch(`${API_BASE}/api/push/diag2`, { headers: { 'Authorization': `Bearer ${token()}` }});
    const j = await r.json().catch(()=> ({}));
    log(`ENV ‚Üí origin=${location.origin}
SW scope=${scope}
diag: total=${j.total} noEndpoint=${j.noEndpoint} invalid=${j.invalid} vapidLen=${j.vapidPublicLen}
newest=${j.newest?.endpoint || '(none)'}
validNewest=${j.validNewest?.endpoint || '(none)'}
`);
  } catch (e) {
    log('env error: ' + e.message);
  }
}

async function cleanup() {
  try {
    const r = await fetch(`${API_BASE}/api/push/cleanup`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token()}` }
    });
    const j = await r.json().catch(()=> ({}));
    log(`cleanup ‚Üí removedInvalid=${j.removedInvalid} removedNoEndpoint=${j.removedNoEndpoint}`);
  } catch (e) {
    log('cleanup error: ' + e.message);
  }
}

async function fixPush() {
  try {
    const reg = await navigator.serviceWorker.getRegistration(`${basePath}/`);
    if (reg) {
      const sub = await reg.pushManager.getSubscription();
      if (sub) await sub.unsubscribe().catch(()=>{});
      await reg.unregister();
    }
    await cleanup();
    log('Cleared local SW + server invalid subs ‚Üí re-enabling‚Ä¶');
    await enablePush();
  } catch (e) {
    log('Fix error: ' + e.message);
  }
}

async function localTest() {
  try {
    const r = await navigator.serviceWorker.getRegistration(`${basePath}/`);
    const sub = await r?.pushManager.getSubscription();
    const endp = sub?.endpoint || '(no sub)';
    const noti = (await navigator.permissions.query({ name: 'notifications' })).state;
    log(`local test ‚Üí swScope=${r?.scope || '(none)'} notifications=${noti} endpoint=${endp}`);
  } catch (e) {
    log('local test error: ' + e.message);
  }
}

// wire UI
document.getElementById('enableBtn').onclick = enablePush;
document.getElementById('serverBtn').onclick = serverTest;
document.getElementById('envBtn').onclick = envInfo;
document.getElementById('fixBtn').onclick = fixPush;
document.getElementById('localBtn').onclick = localTest;
</script>
</body>
</html>
