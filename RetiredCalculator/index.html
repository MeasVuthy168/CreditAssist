<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <title>ការគណនាចំនួនខែចូលនិវត្តន៍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    @font-face {
      font-family: 'Krasar';
      src: url('https://measvuthy168.github.io/CreditAssist/Krasar-Regular.ttf') format('truetype');
    }
    :root{
      --bg:#1c2331;
      --panel:#2c3545;
      --input:#1f2733;
      --brand:#0d2d5c;
      --text:#ffffff;
      --muted:#cfcfcf;
      --line:#555;
      --accent:#3399ff;
    }
    body{font-family:'Krasar',Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:70px}

    /* Header (kept) */
    .header{background:var(--brand);padding:14px 16px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .header .back{font-size:22px;color:#fff;background:none;border:none;margin-right:12px;cursor:pointer}
    .header .title{font-size:17px;font-weight:bold;color:#fff}

    /* Panel & layout */
    .container{max-width:760px;margin:80px auto 0;background:var(--panel);padding:18px;border-radius:12px}
    .form-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .form-row label{flex:0 0 170px;color:var(--muted);font-size:15px;white-space:nowrap} /* ✅ one-line labels */
    .field{flex:1;display:flex;align-items:center;gap:10px}
    .box{flex:1;display:flex;align-items:center;background:var(--input);border:1px solid var(--line);border-radius:8px;height:46px;padding:0 10px;box-sizing:border-box}
    .box input[type="date"], .box input[type="number"]{flex:1;border:none;background:transparent;color:#fff;font-size:16px;outline:none}
    .units{color:#cfd6e1;font-size:14px;white-space:nowrap}

    /* Slider block */
    .age-wrap{flex:1;display:flex;align-items:center;gap:10px}
    .age-slider{flex:1;height:4px;appearance:none;background:#385173;border-radius:999px;outline:none}
    .age-slider::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #3a5a93;box-shadow:0 2px 6px rgba(0,0,0,.35);cursor:pointer}
    .age-num{width:92px;display:flex;align-items:center;justify-content:center;background:#21344c;border:1px solid #3c5068;border-radius:8px;height:46px;font-weight:bold}

    .result-row{display:flex;align-items:center;gap:12px;margin-top:6px}
    .result-title{flex:0 0 170px;color:var(--muted);font-size:15px;white-space:nowrap}
    .result-box{flex:1;height:46px;display:flex;align-items:center;padding:0 10px;border-radius:8px;background:transparent;border:1px dashed #4a5568}
    #monthsLeft{font-weight:bold}

    #description{margin-top:16px;font-size:18px;color:#f0f0f0}
    .highlight{color:var(--accent);font-weight:bold}
    .retired{color:#ff8080 !important;font-weight:bold}

    footer{text-align:center;font-size:14px;color:#aaa;margin-top:22px}

    /* Bottom bar (kept) */
    .bottom-bar{position:fixed;bottom:0;left:0;width:100%;height:56px;background:var(--brand);display:flex;justify-content:space-around;align-items:center;z-index:1000}
    .bottom-btn{display:flex;flex-direction:column;align-items:center;font-size:11px;color:#fff;border:none;background:none}
    .bottom-btn img{margin-bottom:2px;pointer-events:none}
    .badge{position:absolute;top:-4px;right:-8px;background:red;color:#fff;font-size:10px;padding:2px 6px;border-radius:50%;font-weight:bold}

    @media print{.header,.bottom-bar{display:none!important}}
  </style>
</head>
<body>

  <!-- Header (kept) -->
  <div class="header">
    <button class="back" onclick="window.location.href='../index.html'">←</button>
    <div class="title">ការគណនាចំនួនខែចូលនិវត្តន៍</div>
  </div>

  <div class="container">
    <!-- DOB -->
    <div class="form-row">
      <label for="dob">ថ្ងៃខែឆ្នាំកំណើត</label>
      <div class="field">
        <div class="box">
          <input type="date" id="dob" value="1989-09-14">
        </div>
      </div>
    </div>

    <!-- Retirement age (slider + numeric) -->
    <div class="form-row">
      <label for="retirementAge">អាយុចូលនិវត្តន៍</label>
      <div class="field">
        <div class="age-wrap">
          <input id="retirementAge" class="age-slider" type="range" min="0" max="60" value="55" step="1">
          <div class="age-num"><span id="ageDisplay">55</span> ឆ្នាំ</div>
        </div>
        <div class="units"> (0–60)</div>
      </div>
    </div>

    <!-- Current date -->
    <div class="form-row">
      <label for="currentDate">ថ្ងៃខែឆ្នាំបច្ចុប្បន្ន</label>
      <div class="field">
        <div class="box">
          <input type="date" id="currentDate">
        </div>
      </div>
    </div>

    <!-- Months left -->
    <div class="result-row">
      <div class="result-title">ចំនួនខែដែលនៅសល់</div>
      <div class="result-box"><span id="monthsLeft">-</span></div>
    </div>

    <!-- Description -->
    <div id="description"></div>

    <footer>💡គោលបំណងស្វែងរករយៈពេលផ្តល់ឥណទានអោយបានត្រឹមត្រូវតាមគោលការណ៍ សម្រាប់ឥណទានប្រើប្រាស់ផ្ទាល់ខ្លួនដែលធានាដោយប្រាក់បៀវត្សរ៍ ។</footer>
  </div>

  <!-- Bottom bar (kept) -->
  <div class="bottom-bar">
    <button class="bottom-btn" onclick="location.href='../index.html'">
      <img src="../icons/Home.png" width="24" height="24" />
      <div>Home</div>
    </button>
    <button class="bottom-btn" onclick="location.href='../Setting/index.html'">
      <img src="../icons/Setting.png" width="24" height="24" />
      <div>Setting</div>
    </button>
    <button class="bottom-btn" onclick="window.location.href='../notifications/index.html'">
      <div style="position: relative;">
        <img src="../icons/Notification.png" width="24" height="24" />
        <span id="notif-badge" class="badge" style="display:none;"></span>
      </div>
      <div>Notification</div>
    </button>
  </div>

  <!-- Notification badge helper -->
  <script src="../notifications/checkNotification.js"></script>

  <script>
    // ===== Security (kept)
    const token = sessionStorage.getItem('token');
    if (!token) { alert("Session expired or unauthorized access."); window.location.href = "../login.html"; }

    // ===== Auto logout (kept)
    const AUTO_LOGOUT_MINUTES = 10;
    let logoutTimer;
    function resetLogoutTimer(){
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(()=>{
        sessionStorage.clear();
        alert("Session expired. Please log in again.");
        window.location.href="../login.html";
      }, AUTO_LOGOUT_MINUTES*60*1000);
    }
    function setupAutoLogoutEvents(){
      ['mousemove','mousedown','keydown','touchstart','touchmove','scroll'].forEach(e=>{
        document.addEventListener(e, resetLogoutTimer, true);
      });
      resetLogoutTimer();
    }
    window.addEventListener('load', setupAutoLogoutEvents);

    // ===== Dates init
    function setMaxDateToToday(){
      const today = new Date();
      const iso = today.toISOString().split("T")[0];
      const dob = document.getElementById("dob");
      const cur = document.getElementById("currentDate");
      dob.max = iso; cur.max = iso; cur.value = iso;
    }

    // ===== Calculation
    function calculateMonthsLeft(){
      const dobVal = document.getElementById("dob").value;
      const age = parseInt(document.getElementById("retirementAge").value || "0", 10);
      const curVal = document.getElementById("currentDate").value;

      if (!dobVal || !curVal || isNaN(age)) return;

      const dob = new Date(dobVal);
      const current = new Date(curVal);

      const retirementDate = new Date(dob);
      retirementDate.setFullYear(retirementDate.getFullYear() + age);

      const desc = document.getElementById("description");
      const monthsLeftEl = document.getElementById("monthsLeft");

      // Already retired
      if (retirementDate < current) {
        let years = current.getFullYear() - retirementDate.getFullYear();
        let months = current.getMonth() - retirementDate.getMonth();
        let days = current.getDate() - retirementDate.getDate();

        if (days < 0) {
          months -= 1;
          const prevMonth = new Date(current.getFullYear(), current.getMonth(), 0);
          days += prevMonth.getDate();
        }
        if (months < 0) { years -= 1; months += 12; }

        monthsLeftEl.textContent = "មិនមានចំនួនខែដែលនៅសល់";
        desc.classList.add("retired");
        desc.innerHTML =
          `បានចូលនិវត្តន៍ចំនួន <span class="highlight">${String(years).padStart(2,'0')}</span> ឆ្នាំ `+
          `<span class="highlight">${String(months).padStart(2,'0')}</span> ខែ `+
          `និង <span class="highlight">${String(days).padStart(2,'0')}</span> ថ្ងៃ ហើយ`;
        return;
      }

      // Not yet retired
      let years = retirementDate.getFullYear() - current.getFullYear();
      let months = retirementDate.getMonth() - current.getMonth();
      let days = retirementDate.getDate() - current.getDate();

      if (days < 0) {
        months -= 1;
        const prevMonth = new Date(retirementDate.getFullYear(), retirementDate.getMonth(), 0);
        days += prevMonth.getDate();
      }
      if (months < 0) { years -= 1; months += 12; }

      const totalMonthsLeft = years * 12 + months;
      monthsLeftEl.textContent = `${totalMonthsLeft} ខែ`;

      desc.classList.remove("retired");
      desc.innerHTML =
        `នៅសល់ <span class="highlight">${String(years).padStart(2,'0')}</span> ឆ្នាំ `+
        `<span class="highlight">${String(months).padStart(2,'0')}</span> ខែ `+
        `និង <span class="highlight">${String(days).padStart(2,'0')}</span> ថ្ងៃទៀត`;
    }

    // ===== Wire up
    window.addEventListener("DOMContentLoaded", () => {
      setMaxDateToToday();
      const slider = document.getElementById("retirementAge");
      const ageDisplay = document.getElementById("ageDisplay");

      slider.addEventListener("input", () => {
        ageDisplay.textContent = slider.value;
        calculateMonthsLeft();
      });

      ["dob","currentDate"].forEach(id=>{
        document.getElementById(id).addEventListener("change", calculateMonthsLeft);
      });

      calculateMonthsLeft();
      if (typeof checkNotification === 'function') checkNotification();
    });
  </script>
</body>
</html>
