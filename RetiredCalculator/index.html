<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <title>ការគណនាចំនួនខែចូលនិវត្តន៍</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d2d5c" />
  <style>
    @font-face {
      font-family: 'Krasar';
      src: url('https://measvuthy168.github.io/CreditAssist/Krasar-Regular.ttf') format('truetype');
    }

    :root{
      --brand:#0d2d5c;
      --bg:#0f1b2c;
      --panel:#1b2638;
      --field:#21344c;
      --field-border:#3c5068;
      --text:#e6eefb;
      --muted:#a8b5c7;
      --accent:#49a2ff;
      --danger:#ff6b6b;
    }

    *{box-sizing:border-box}
    body{font-family:'Krasar',Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:70px}

    /* Header */
    .header{
      background:var(--brand);
      padding:14px 16px;
      display:flex;
      align-items:center;
      position:fixed;left:0;right:0;top:0;z-index:1000;
      box-shadow:0 2px 5px rgba(0,0,0,.25);
    }
    .header .back{font-size:22px;color:#fff;background:none;border:none;margin-right:12px;cursor:pointer}
    .header .title{font-size:17px;font-weight:bold;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Panel */
    .panel{
      max-width:720px;margin:80px auto 0;background:var(--panel);
      border-radius:16px;padding:18px 14px;
    }

    /* Row layout */
    .form-row{display:flex;align-items:center;gap:10px;margin:10px 6px}
    .form-row label{
      flex:0 0 140px;               /* ✅ one-line Khmer label */
      color:var(--muted);
      font-size:15px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .field{
      flex:1;display:flex;flex-direction:column;gap:8px;min-width:0;
    }

    .box{
      width:100%;height:48px;background:var(--field);
      border:1px solid var(--field-border);border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-size:17px;color:#fff;
      padding:0 12px;
    }

    
    .box input[type="date"]{
      width:100%;height:100%;border:none;background:transparent;color:#fff;font-family:'Krasar',sans-serif;font-size:16px;outline:none;
    }

    /* ===== Age slider + numeric input ===== */
    .age-wrap{display:flex;align-items:center;gap:1px;min-width:0}
    .age-slider{
      flex:1;appearance:none;height:6px;border-radius:999px;background:#385173;outline:none;
    }
    .age-slider::-webkit-slider-thumb{
      appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #2f4378;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }
    .age-slider::-moz-range-thumb{
      width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #2f4378;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }

    .age-num{
      flex:0 0 110px;height:48px;background:var(--field);
      border:1px solid var(--field-border);border-radius:10px;
      display:flex;align-items:center;justify-content:center;gap:6px;padding:0 10px;
    }

    .age-num input{
      width:46px;border:none;background:transparent;color:#fff;font-size:17px;text-align:center;outline:none;
    }
    .units{color:var(--muted);font-size:14px;white-space:nowrap}

    .result-box{margin:10px 6px;padding:14px;border:1px dashed #3f5471;border-radius:12px;background:#162234}
    .result-title{color:var(--muted);font-size:14px;margin-bottom:6px}
    .months-big{font-size:22px;font-weight:bold}
    .desc{margin-top:6px;font-size:18px}
    .desc .num{color:var(--accent);font-weight:bold}
    .desc.retired{color:var(--danger)}
    .foot-note{margin:14px 6px 0;color:#90a0b8;font-size:14px;line-height:1.6}

    /* Bottom bar */
    .bottom-bar{position:fixed;bottom:0;left:0;width:100%;height:56px;background:var(--brand);display:flex;justify-content:space-around;align-items:center;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,.3)}
    .bottom-btn{display:flex;flex-direction:column;align-items:center;font-size:11px;color:#fff;background:none;border:none}
    .bottom-btn img{margin-bottom:2px;pointer-events:none}
    .badge{position:absolute;top:-4px;right:-8px;background:red;color:#fff;font-size:10px;padding:2px 6px;border-radius:50%;font-weight:bold}

    @media (max-width:420px){
      .form-row label{flex:0 0 120px}
      .age-num{flex-basis:100px}
    }

    @media print{.header,.bottom-bar{display:none !important}}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <button class="back" onclick="window.location.href='../index.html'">←</button>
    <div class="title">ការគណនាចំនួនខែចូលនិវត្តន៍</div>
  </div>

  <!-- Panel -->
  <div class="panel">

    <div class="form-row">
      <label for="dob">ថ្ងៃខែឆ្នាំកំណើត</label>
      <div class="field">
        <div class="box">
          <input type="date" id="dob" />
        </div>
      </div>
    </div>

    <div class="form-row">
      <label for="retirementAge">អាយុចូលនិវត្តន៍</label>
      <div class="field">
        <div class="age-wrap">
          <!-- Longer slider -->
          <input id="retirementAge" class="age-slider" type="range" min="0" max="60" value="55" step="1">
          <!-- Editable number box -->
          <div class="age-num">
            <input type="number" id="ageInput" min="0" max="60" value="55"> ឆ្នាំ
          </div>
        </div>
        <div class="units">(0–60)</div>
      </div>
    </div>

    <div class="form-row">
      <label for="currentDate">ថ្ងៃខែឆ្នាំបច្ចុប្បន្ន</label>
      <div class="field">
        <div class="box">
          <input type="date" id="currentDate" />
        </div>
      </div>
    </div>

    <div class="result-box">
      <div class="result-title">ចំនួនខែដែលនៅសល់</div>
      <div id="monthsLeft" class="months-big">—</div>
      <div id="description" class="desc"></div>
    </div>

    <div class="foot-note">
      💡 គោលបំណង៖ កំណត់រយៈពេលផ្តល់ឥណទានឲ្យបានត្រឹមត្រូវតាមគោលការណ៍ សម្រាប់ឥណទានប្រើប្រាស់ផ្ទាល់ខ្លួន
      ដែលធានាដោយប្រាក់បៀវត្សា៕
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <button class="bottom-btn" onclick="location.href='../index.html'">
      <img src="../icons/Home.png" width="24" height="24" />
      <div>Home</div>
    </button>
    <button class="bottom-btn" onclick="location.href='../Setting/index.html'">
      <img src="../icons/Setting.png" width="24" height="24" />
      <div>Setting</div>
    </button>
    <button class="bottom-btn" onclick="window.location.href='../notifications/index.html'">
      <div style="position: relative;">
        <img src="../icons/Notification.png" width="24" height="24" />
        <span id="notif-badge" class="badge" style="display:none;"></span>
      </div>
      <div>Notification</div>
    </button>
  </div>

  <!-- Shared badge helper -->
  <script src="../notifications/checkNotification.js"></script>

  <script>
    // ===== Auth guard
    const token = sessionStorage.getItem('token');
    if (!token) { alert("Session expired or unauthorized access."); window.location.href = "../login.html"; }

    // ===== Auto logout
    const AUTO_LOGOUT_MINUTES = 10;
    let logoutTimer;
    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        sessionStorage.clear();
        alert("Session expired. Please log in again.");
        window.location.href = "../login.html";
      }, AUTO_LOGOUT_MINUTES * 60 * 1000);
    }
    function setupAutoLogoutEvents() {
      ['mousemove','mousedown','keydown','touchstart','touchmove','scroll'].forEach(e =>
        document.addEventListener(e, resetLogoutTimer, true)
      );
      resetLogoutTimer();
    }
    window.addEventListener('load', setupAutoLogoutEvents);

    // ===== Date initial values
    function initDates() {
      const todayStr = new Date().toISOString().split("T")[0];
      const dobEl = document.getElementById("dob");
      const curEl = document.getElementById("currentDate");

      // DOB: cannot be in the future
      dobEl.max = todayStr;
      if (!dobEl.value) dobEl.value = "1989-09-14";

      // Current date: allowed to be > today (no max)
      if (!curEl.value) curEl.value = todayStr;
    }

    // ===== Calculation helpers
    function clamp(n, min, max) { return Math.min(Math.max(n, min), max); }

    function monthDiffDetailed(from, to) {
      // returns {years, months, days, totalMonths, negative}
      let negative = false;
      let a = new Date(from), b = new Date(to);
      if (b < a) { negative = true; [a,b] = [b,a]; }

      let years = b.getFullYear() - a.getFullYear();
      let months = b.getMonth() - a.getMonth();
      let days = b.getDate() - a.getDate();

      if (days < 0) {
        months -= 1;
        // days in previous month of b
        const prevB = new Date(b.getFullYear(), b.getMonth(), 0);
        days += prevB.getDate();
      }
      if (months < 0) {
        years -= 1;
        months += 12;
      }
      const totalMonths = years * 12 + months;
      return { years, months, days, totalMonths, negative };
    }

    function calculateMonthsLeft() {
      const dob = new Date(document.getElementById("dob").value);
      const age = parseInt(document.getElementById("ageInput").value || "0", 10);
      const current = new Date(document.getElementById("currentDate").value);
      if (!dob || isNaN(dob.getTime())) return;
      if (!current || isNaN(current.getTime())) return;

      const retirementDate = new Date(dob);
      retirementDate.setFullYear(retirementDate.getFullYear() + age);

      const desc = document.getElementById("description");
      const monthsBox = document.getElementById("monthsLeft");

      if (current >= retirementDate) {
        // Already retired
        const d = monthDiffDetailed(retirementDate, current);
        monthsBox.textContent = "មិនមានចំនួនខែដែលនៅសល់";
        desc.classList.add("retired");
        desc.innerHTML = `បានចូលនិវត្តន៍ចំនួន <span class="num">${String(d.years).padStart(2,'0')}</span> ឆ្នាំ
          <span class="num">${String(d.months).padStart(2,'0')}</span> ខែ
          និង <span class="num">${String(d.days).padStart(2,'0')}</span> ថ្ងៃ ហើយ`;
      } else {
        const d = monthDiffDetailed(current, retirementDate);
        monthsBox.textContent = `${d.totalMonths} ខែ`;
        desc.classList.remove("retired");
        desc.innerHTML = `នៅសល់ <span class="num">${String(d.years).padStart(2,'0')}</span> ឆ្នាំ
          <span class="num">${String(d.months).padStart(2,'0')}</span> ខែ
          និង <span class="num">${String(d.days).padStart(2,'0')}</span> ថ្ងៃទៀត`;
      }
    }

    // ===== Age controls sync
    function initAgeControls() {
      const slider = document.getElementById("retirementAge");
      const input = document.getElementById("ageInput");

      function setVal(v) {
        const n = clamp(parseInt(v || "0", 10), 0, 60);
        slider.value = n;
        input.value = n;
        calculateMonthsLeft();
      }
      slider.addEventListener("input", () => setVal(slider.value));
      input.addEventListener("input", () => setVal(input.value));
      setVal(slider.value);
    }

    // ===== Init
    window.addEventListener("DOMContentLoaded", () => {
      initDates();
      initAgeControls();
      calculateMonthsLeft();

      // Badge
      if (typeof checkNotification === 'function') checkNotification();

      // Recalculate when dates change
      ["dob","currentDate"].forEach(id => {
        document.getElementById(id).addEventListener("change", calculateMonthsLeft);
      });
    });
  </script>
</body>
</html>
