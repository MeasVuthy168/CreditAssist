
<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <title>ជំនួយការឥណទាន</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d2d5c" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    @font-face {
      font-family: 'Krasar';
      src: url('Krasar-Regular.ttf') format('truetype');
    }

    body {
      font-family: 'Krasar', Arial, sans-serif;
      background-color: #002c5f;
      color: white;
      margin: 0;
      padding: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #0d2d5c;
      padding: 10px 16px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .header img.logo {
      height: 50px;
    }

    .profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
    }

    .profile-wrapper {
      position: relative;
      width: 64px;
      height: 64px;
    }

    .spinner-arc {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(#ffd700 0% 25%, transparent 25% 100%);
      animation: spin 1.8s linear infinite;
      z-index: 1;
    }

    .profile-wrapper img {
      width: calc(100% - 2px);
      height: calc(100% - 2px);
      border-radius: 50%;
      object-fit: cover;
      background-color: white;
      z-index: 2;
      margin: 1px;
      position: relative;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .welcome {
      font-size: 13px;
      color: #ffd700;
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
    }

    .main-box {
      background-color: transparent;
      border-radius: 16px;
      padding: 20px;
      width: 96%;
      max-width: 400px;
      color: #002c5f;
      margin: 100px auto 20px;
      /* box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25); */
      height: calc(100vh - 140px);
      box-sizing: border-box;
      overflow-y: auto;
    }

    .content {
      padding: 0;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      justify-items: center;
    }

    .menu-item {
      background: white;
      border-radius: 16px;
      padding: 10px 6px;
      width: 100%;
      max-width: 90px;
      aspect-ratio: 1/1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color:​ #002c5f;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-align: center;
      position: relative;
      overflow: hidden;
      user-select: none;
      transition: all 0.3s ease;
    }
.menu-item img {
  width: 36px;
  height: 36px;
  margin-bottom: 6px;
  animation: bounce 0.4s ease;
  pointer-events: none;
}
  

    .menu-item:hover {
      background: #f0f8ff;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
      border: 1.5px solid #ffd700;
    }

    .menu-item:hover img {
      transform: scale(1.15);
    }

    .menu-item .label {
      font-size: 12px;
    }

    @keyframes bounce {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(0, 44, 95, 0.3);
      transform: scale(0);
      animation: ripple-animation 0.6s ease-out;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 56px;
      background: #0d2d5c;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    .bottom-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      color: white;
      border: none;
      background: none;
      padding: 2px;
    }

   .bottom-btn img {
  margin-bottom: 2px;
  pointer-events: none;
}

    .bottom-btn.active {
  filter: brightness(1.2) drop-shadow(0 0 3px #ffd700);
}
    .robot-box {
  position: fixed;
  left: 16px;
  right: 16px;
  bottom: 76px; /* ✅ Make sure it FLOATS ABOVE the bottom bar (56px + small gap) */
  background-color: rgba(0, 0, 0, 0.1);
  border: 2px solid #d4af37;
  border-radius: 12px;
  padding: 10px 16px 70px; /* ✅ Padding bottom to reserve space for microphone */
  font-family: 'Krasar', sans-serif;
  color: white;
  height: 60px; /* ✅ FIXED HEIGHT */
  /*overflow-y: auto; /* ✅ SCROLL when too much text */
  display: flex;
  overflow: hidden;
  flex-direction: column;
  box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
  z-index: 999; /* Make sure it's above most things */
}
    .robot-box img {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .robot-message {
      display: flex;
      align-items: flex-start;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 8px;
      word-break: break-word;
      color: #ffd700;
      flex: 1; /* ✅ Fill available space */
      overflow-y: auto; /* ✅ Scroll the text inside */
    }   
        .flicker {
      animation: flicker 2s infinite;
    }
    
    @keyframes flicker {
      0%, 100% { color: #ffd700; }
      20% { color: #ffffff; }
      40% { color: #ffda6b; }
      60% { color: #ffd700; }
      80% { color: #ffe87e; }
    }

    .robot-float {
      animation: floatBot 2.8s ease-in-out infinite;
    }
    
    @keyframes floatBot {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    .mic-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 50px;
      height: 50px;
      background-color: #0d2d5c;
      border: 2px solid white; /* Optional for better contrast */
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .mic-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      filter: invert(100%);
      padding-left: 14PX
    }
    .mic-float {
      position: absolute;
      right: 18px;
      bottom: 12px;
      z-index: 2;
    }

    img {
      pointer-events: none;
      -webkit-user-drag: none;
      user-drag: none;
    }
    .voice-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
}

.voice-box {
  background: white;
  border-radius: 18px;
  width: 90%;
  max-width: 350px;
  padding: 24px 20px;
  text-align: center;
  font-family: 'Krasar', sans-serif;
  color: #0d2d5c;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.voice-greet {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}

.voice-question {
  font-size: 16px;
  margin-bottom: 20px;
}

.voice-tip {
  font-size: 13px;
  color: gray;
}

/* Mic button layout */
.voice-mic-btn {
  border: none;
  background: none;
  padding: 0;
  margin: 0 auto 14px;
  cursor: pointer;
  position: relative;
}

.mic-ring {
  width: 72px;
  height: 72px;
  background-color: #ffd700;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mic-core {
  width: 52px;
  height: 52px;
  background-color: #0d2d5c;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.voice-stop-icon {
  width: 20px;
  height: 20px;
  background-color: white;
  border-radius: 4px;
}
/* Mic glow animation (optional reuse for listening) */
@keyframes micGlow {
  0% { box-shadow: 0 0 0 0 rgba(13, 45, 92, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(13, 45, 92, 0); }
  100% { box-shadow: 0 0 0 0 rgba(13, 45, 92, 0); }
}

.voice-mic-btn.listening,
.mic-btn.listening {
  animation: micGlow 1.2s infinite;
}
    .badge {
  position: absolute;
  top: -4px;
  right: -8px;
  background: red;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 50%;
  font-weight: bold;
}

   #toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 16px 24px;
  border-radius: 10px;
  font-family: 'Krasar', Arial, sans-serif;
  font-size: 16px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
} 
  </style>
</head>
<body oncontextmenu="return false;">
  <!-- Header -->
  <div class="header">
    <img class="logo" src="LogoAC2.PNG" alt="Logo" />
    <a href="Setting/userinfo.html" class="profile">
      <div class="profile-wrapper">
        <div class="spinner-arc"></div>
        <img id="profile-photo" alt="User" />
      </div>
      <div class="welcome" id="welcome">សួស្តី</div>
    </a>
  </div>
  
<!-- Voice Assistant Popup -->
<div id="voiceOverlay" class="voice-overlay" style="display: none;">
  <div class="voice-box">
    <div class="voice-greet" id="voiceGreeting">សួស្តី ...</div>
    <div class="voice-question">តើខ្ញុំអាចជួយអ្វីបាន?</div>

    <button id="stopMic" class="voice-mic-btn">
      <div class="mic-ring">
        <div class="mic-core">
          <div class="voice-stop-icon"></div>
        </div>
      </div>
    </button>

    <div class="voice-tip">សាកល្បងនិយាយ <strong>"ស្វែងរក"</strong></div>

    <!-- ✅ Live subtitle display -->
    <div id="liveSubtitle" style="font-size: 15px; color: #555; min-height: 24px;"></div>
  </div>
</div>
  
  <!-- Main Box -->
  <div class="main-box">
    <!-- Content -->
    <div class="content">
      <div class="menu-grid">
        <div class="menu-item" data-href="SVG_CRM/index.html"><img src="icons/search.PNG"><div class="label">ស្វែងរកអតិថិជន</div></div>
        <div class="menu-item" data-href="RetiredCalculator/index.html"><img src="icons/retirement.PNG"><div class="label">ចំនួនខែចូលនិវត្តន៍</div></div>
        <div class="menu-item" data-href="Loan-Calculator/index.html"><img src="icons/loan.PNG"><div class="label">គណនាឥណទាន</div></div>
        <div class="menu-item" data-href="Average-Debit-Turnover/index.html"><img src="icons/turnover.PNG"><div class="label">Average Turnover</div></div>
        <div class="menu-item" data-href=""><img src="icons/report.PNG"><div class="label">របាយការណ៍ភ្នាក់ងារឥណទាន</div></div>
        <div class="menu-item" data-href=""><img src="icons/check.PNG"><div class="label">Spot Check Loan</div></div>
        <div class="menu-item" data-href=""><img src="icons/overdue.PNG"><div class="label">Daily Arreas</div></div>
      </div>
    </div>

         <!-- Robot Box -->
      <div class="robot-box">
        <div style="display: flex; align-items: center;">
          <img class="robot-float" src="icons/Robot.svg" alt="Robot">
          <div class="robot-message flicker" id="robotMessage">កំពុងផ្ទុកសារ...</div>
        </div>

        <!-- ✅ Mic button always visible and floats inside bottom-right -->
        <button class="mic-btn mic-float">
          <img src="icons/mic.svg" alt="Mic" />
        </button>
      </div>

      
    
      <!-- Footer -->
  <div class="bottom-bar">
  <button class="bottom-btn active" onclick="window.location.href='index.html'">
    <img src="icons/Home.png" width="24" height="24" /><div>Home</div>
  </button>
  <button class="bottom-btn" onclick="window.location.href='Setting/index.html'">
    <img src="icons/Setting.png" width="24" height="24" /><div>Setting</div>
  </button>
  <button class="bottom-btn" onclick="window.location.href='notifications/index.html'">
  <div style="position: relative;">
    <img src="icons/Notification.png" width="24" height="24" />
    <span id="notif-badge" class="badge" style="display: none;"></span>
  </div>
  <div>Notification</div>
</button>
</div>
<div id="toast"></div>
    
<script>
// ✅ Check Token
const token = sessionStorage.getItem('token');
if (!token) {
  alert("Session expired or unauthorized access.");
  window.location.href = "login.html";
}

// ✅ Auto Logout Timer
const AUTO_LOGOUT_MINUTES = 1;
let logoutTimer;
function resetLogoutTimer() {
  clearTimeout(logoutTimer);
  logoutTimer = setTimeout(() => {
    sessionStorage.clear();
    alert("Session expired due to inactivity. Please log in again.");
    window.location.href = "login.html";
  }, AUTO_LOGOUT_MINUTES * 60 * 1000);
}

// Attach reset to more events
function setupAutoLogoutEvents() {
  ['mousemove', 'mousedown', 'keydown', 'touchstart', 'touchmove', 'scroll'].forEach(event => {
    document.addEventListener(event, resetLogoutTimer, true);
  });
  resetLogoutTimer(); // Start countdown immediately
}

window.addEventListener('load', setupAutoLogoutEvents);

// ✅ Load Profile Info and Robot Message
document.addEventListener('DOMContentLoaded', () => {
  const name = sessionStorage.getItem("fullname") || "អ្នកប្រើ";
  const imgPath = sessionStorage.getItem("image") || "profile/non-image.jpg";
  const profilePhoto = document.getElementById("profile-photo");

  document.getElementById("welcome").textContent = "សួស្តី, " + name;

  profilePhoto.src = "https://secure-backend-tzj9.onrender.com/" + imgPath;
  profilePhoto.onerror = function() {
    this.onerror = null;
    this.src = "icons/default-profile.png"; // fallback
  };

  loadRobotMessage();
});

// ✅ Load Robot Message API
async function loadRobotMessage() {
  try {
    const res = await fetch("https://secure-backend-tzj9.onrender.com/api/robot-message", {
      headers: { Authorization: `Bearer ${sessionStorage.getItem('token')}` }
    });
    const data = await res.json();
    document.getElementById("robotMessage").textContent = data.message || "មិនទាន់មានសារ។";
  } catch (error) {
    console.error("Robot message error:", error);
    document.getElementById("robotMessage").textContent = "មិនអាចទាញសារបានទេ។";
  }
}

// ✅ Menu Button Ripple and Navigation
document.querySelectorAll(".menu-item").forEach(item => {
  const href = item.getAttribute("data-href");
  item.addEventListener("click", function (e) {
    e.preventDefault();
    if (navigator.vibrate) navigator.vibrate(50);

    const ripple = document.createElement("span");
    ripple.className = "ripple";
    const rect = this.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    ripple.style.width = ripple.style.height = size + "px";
    ripple.style.left = (e.clientX - rect.left - size / 2) + "px";
    ripple.style.top = (e.clientY - rect.top - size / 2) + "px";
    this.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);

    if (href) window.location.href = href;
    else alert("Coming soon!");
  });
});

// ✅ Voice Assistant Setup
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const speechSupported = !!SpeechRecognition;
let recognition;

window.addEventListener('DOMContentLoaded', () => {
  const micButton = document.querySelector('.mic-btn');
  if (isIOS || !speechSupported) {
    if (micButton) micButton.style.display = "none";
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = 'km-KH';
  recognition.continuous = false;
  recognition.interimResults = true;

  recognition.onstart = () => {
    document.getElementById("liveSubtitle").textContent = "កំពុងស្តាប់...";
  };

  recognition.onresult = (event) => {
    let finalTranscript = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        document.getElementById("liveSubtitle").textContent = transcript;
      }
    }

    if (finalTranscript.trim()) {
      handleVoiceCommand(finalTranscript.toLowerCase());
    }
  };

  recognition.onend = () => {
    document.getElementById("liveSubtitle").textContent = "";
  };

  recognition.onerror = (event) => {
    console.error("Speech error:", event.error);
    if (event.error !== "not-allowed") {
      alert("បញ្ហាក្នុងការស្ដាប់សម្លេង: " + event.error);
    }
  };

  const overlay = document.getElementById("voiceOverlay");
  const stopMicBtn = document.getElementById("stopMic");

  if (micButton) {
    micButton.addEventListener('pointerdown', () => {
      overlay.style.display = "flex";
      stopMicBtn.classList.add("listening");
      micButton.classList.add("listening");
      try {
        recognition.start();
      } catch (e) {
        console.log("Already recording");
      }
    });

    const stopListening = () => {
      recognition.stop();
      overlay.style.display = "none";
      stopMicBtn.classList.remove("listening");
      micButton.classList.remove("listening");
    };

    micButton.addEventListener('pointerup', stopListening);
    micButton.addEventListener('pointercancel', stopListening);
    stopMicBtn.addEventListener("click", stopListening);
  }
});

// ✅ Handle Voice Command
function handleVoiceCommand(command) {
  let found = false;
  document.querySelectorAll('.menu-item').forEach(item => {
    const labelText = item.querySelector('.label')?.textContent?.toLowerCase() || '';
    if (labelText.includes(command)) {
      found = true;
      item.click();
    }
  });

  if (!found) alert(`កម្មវិធី "${command}" មិនមានទេ!`);
}
  
  async function checkNotification() {
  try {
    const user = JSON.parse(sessionStorage.getItem("loggedInUser") || "{}");
    const username = user.username || "";

    const res = await fetch("https://secure-backend-tzj9.onrender.com/api/notifications/status");
    const data = await res.json();

    const uploads = ['user', 'customer', 'turnover', 'nbcos'];
    const lastReadRaw = data[`read_${username}`];
    const lastRead = lastReadRaw ? new Date(lastReadRaw) : null;

    let newCount = 0;
    uploads.forEach(type => {
      const dateStr = data[type];
      if (!dateStr) return;
      const uploadedAt = new Date(dateStr);
      if (!lastRead || uploadedAt > lastRead) newCount++;
    });

    const badge = document.getElementById("notif-badge");
    if (newCount > 0) {
      badge.textContent = newCount > 9 ? "9+" : newCount;
      badge.style.display = "inline-block";
    } else {
      badge.style.display = "none";
    }

  } catch (err) {
    console.error("Notification fetch error:", err);
  }
}
  
  window.addEventListener('load', () => {
  setupAutoLogoutEvents();
  checkNotification();
});

  
</script>
</body>
</html>
