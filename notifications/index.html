<script>
  // ✅ Protect Page by Token
  const token = sessionStorage.getItem('token');
  if (!token) {
    alert("Session expired or unauthorized access.");
    window.location.href = "../login.html";
  }

  const AUTO_LOGOUT_MINUTES = 1;
  let logoutTimer;
  function resetLogoutTimer() {
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(() => {
      sessionStorage.clear();
      alert("Session expired due to inactivity. Please log in again.");
      window.location.href = "../login.html";
    }, AUTO_LOGOUT_MINUTES * 60 * 1000);
  }
  function setupAutoLogoutEvents() {
    ['mousemove', 'mousedown', 'keydown', 'touchstart', 'touchmove', 'scroll'].forEach(event => {
      document.addEventListener(event, resetLogoutTimer, true);
    });
    resetLogoutTimer();
  }
  window.addEventListener('load', setupAutoLogoutEvents);

  const user = JSON.parse(sessionStorage.getItem("loggedInUser") || "{}");
  const username = user.username || "";

  // ✅ Notification message mapping
  const notificationMessages = {
    user: "បានធ្វើបច្ចុប្បន្នភាពទិន្នន័យ​ភ្នាក់ងារឥណទាន",
    customer: "បានធ្វើបច្ចុប្បន្នភាពទិន្នន័យអតិថិជន",
    turnover: "បានធ្វើបច្ចុប្បន្នភាពទិន្នន័យ​ (Debit Turnover)",
    nbcos: "បានធ្វើបច្ចុប្បន្នភាពទិន្នន័យឥណទានសកម្ម​ (NBC Loan Outstanding Grid Merge)"
  };

  async function loadNotifications() {
    const container = document.getElementById('notificationContainer');
    const badge = document.getElementById('notif-badge');
    container.innerHTML = '';

    try {
      const res = await fetch("https://secure-backend-tzj9.onrender.com/api/notifications/status");
      const data = await res.json();
      const readTime = data[`read_${username}`] ? new Date(data[`read_${username}`]) : null;
      let count = 0;

      ['user', 'customer', 'turnover', 'nbcos'].forEach(type => {
        const uploadedAt = data[type];
        const fullname = data[`${type}_by`] || "Unknown"; // FIXED: get from _by field
        const message = notificationMessages[type] || "បានធ្វើបច្ចុប្បន្នភាព";

        if (uploadedAt) {
          const dateObj = new Date(uploadedAt);
          const isNew = !readTime || dateObj > readTime;
          if (isNew) count++;

          const card = document.createElement('div');
          card.className = 'card' + (isNew ? '' : ' read');
          card.innerHTML = `
            <div class="card-title">${type.toUpperCase()} Uploaded</div>
            <div class="card-date">${dateObj.toLocaleString()}</div>
            <div class="card-message">${message}</div>
            <div class="card-message">Uploaded by: <strong>${fullname}</strong></div>
          `;
          container.appendChild(card);
        }
      });

      badge.style.display = count > 0 ? 'inline-block' : 'none';
      badge.textContent = count > 9 ? '9+' : count;

    } catch (err) {
      container.innerHTML = '<p style="padding:12px;">Failed to load notifications.</p>';
      console.error("Error loading notifications:", err);
    }
  }

  function toggleMenu() {
    const menu = document.getElementById("notifMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  async function markAllAsRead() {
    await fetch("https://secure-backend-tzj9.onrender.com/api/notifications/mark-read", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });
    toggleMenu();
    loadNotifications();
    setTimeout(() => {
      document.querySelectorAll('.card').forEach(card => {
        card.classList.add('read');
      });
    }, 300);
  }

  function clearAll() {
    const container = document.getElementById('notificationContainer');
    container.innerHTML = '';
    document.getElementById('notif-badge').style.display = 'none';
    toggleMenu();
  }

  loadNotifications();
</script>
