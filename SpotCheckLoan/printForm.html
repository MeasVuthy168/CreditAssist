
<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <title>Credit Spot Check Form</title>
  <style>
    @font-face {
  font-family: 'Krasar';
  src: url('../Krasar-Regular.ttf') format('truetype');
}

/* Base Styles */
body {
  font-family: 'Krasar', Arial, sans-serif;
  margin: 0;
  padding: 20px;
  font-size: 12px;
}

/* Containers */
.header-container {
  border: 2px solid transparent;
  padding: 5px;
  margin: 0 auto;
  max-width: 850px;
  box-sizing: border-box;
}

.page-container {
  border: 2px solid black;
  padding: 5px;
  margin: 0 auto;
  max-width: 850px;
  box-sizing: border-box;
}

/* Header Layout */
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  font-size: 12px;
}

.header-left {
  font-weight: bold;
  font-size: 13px;
  margin-top: 15px;
}

.print-button-container {
  margin-top: 8px;
}

.header-center {
  text-align: center;
  flex: 1;
  font-weight: bold;
  font-size: 14px;
  margin-top: 14px;
}

.header-right {
  text-align: right;
  font-weight: bold;
  font-size: 13px;
}

.header-right img {
  width: 160px; /* increased size */
  height: auto;
  margin-top: -10; /* remove top margin */
  
}

.short-divider {
  width: 80px;
  height: 3px;
  background-color: black;
  margin: 6px auto;
}

.decor-line {
  text-align: center;
  font-family: monospace;
  margin-top: 4px;
}

/* Section Titles */
.form-section {
  border: 2px solid black;
  padding: 5px 0 5px 14px;
  background: #e0e0e0;
  font-weight: bold;
  margin-top: 20px;
  font-size: 12px;
}

.subsection-title {
  font-weight: bold;
  margin-top: 10px;
  font-size: 12px;
  margin-left: 16px;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 6px;
  table-layout: auto;
}

td {
  border: 1px solid #333;
  padding: 6px 10px;
  vertical-align: top;
}

.checkbox {
  margin-right: 8px;
}

/* Signature Block */
.full-width-section {
  text-align: center;
  font-size: 12px;
  font-weight: bold;
  margin-top: 5px;
  width: 30%; /* Adjust width as you like */
  margin-left: auto; /* This pushes it to the right */
  padding: 5px 0;
  box-sizing: border-box;
}

.full-width-section #checkDate {
  margin-bottom: 10px;
  font-size: 12px;
}

.full-width-section #signatureName {
  display: inline-block;
  margin-top: 20px;
  font-size: 12px;
}

/* Buttons */
.print-button {
  padding: 8px 20px;
  font-size: 14px;
  font-weight: bold;
  background-color: #0d2d5c;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

@media print {
  .print-button {
    display: none;
  }
  .close-button {
    display: none !important;
  }
}

.close-button {
  position: fixed;
  top: 20px;
  right: 10px;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 9999;
  padding: 0;
}

.close-button img {
  width: 60px;  /* adjust size as you want */
  height: 60px;
  object-fit: contain;
}

.close-button:hover img {
  filter: brightness(0.7);  /* darker when hover */
}

.white-border-table td,
.white-border-table th {
  border: 1px solid white;
}
    
</style>
<head>
  <meta charset="UTF-8">
  <title>Credit Spot Check Form</title>
  <link rel="stylesheet" href="credit-spot-check.css"> <!-- Link to external CSS -->
</head>
<body>

  <div class="header-container">
    <div class="header">
      <div class="header-left">
        សាខាខេត្តស្វាយរៀង
        <div class="print-button-container">
          <button class="print-button" onclick="window.print()">បោះពុម្ព (Print Form)</button>
        </div>
      </div>
  <button id="closeBtn" class="close-button">
    <img src="../icons/close.png" alt="Close" />
  </button>
      
      <div class="header-center">
        ព្រះរាជាណាចក្រកម្ពុជា<br>
        ជាតិ សាសនា ព្រះមហាក្សត្រ<br>
        <div class="short-divider"></div>
        ត្រួតពិនិត្យកិច្ចការឥណទាន<br>
        (Credit Spot Check)<br>
        <div class="decor-line">~~~*~~~</div>
      </div>
      <div class="header-right" style="position: relative;">
       <img src="../icons/LogoAC2.PNG" alt="ACLEDA Logo">
       <div>ត្រួតពិនិត្យវដ្ត: <input id="cycleInput" type="text" value="" style="width: 40px;"></div>
      </div>
    </div>
  </div>

  <div class="page-container">



<!-- Section I -->
<div class="form-section">I. ព័ត៌មានឥណទាន (Credit Information)</div>

<!-- Subsection ក -->
<div class="subsection-title">ក - ព័ត៌មានអតិថិជន</div>
<table class="white-border-table">
  <tr>
    <td>ឈ្មោះអតិថិជន:</td><td id="customerName"></td>
    <td>លេខអតិថិជន:</td><td id="customerID"></td>
    <td>ទំហំឥណទាន:</td><td id="loanSize"></td>
  </tr>
  <tr>
    <td>សមតុល្យឥណទាន:</td><td id="osUSD"></td>
    <td>អត្រាការប្រាក់:</td><td id="rate"></td>
    <td>រូបិយប័ណ្ណ:</td><td id="ccy"></td>
  </tr>
  <tr>
    <td>ថ្ងៃបញ្ចេញឥណទាន:</td><td id="disburse"></td>
    <td>ថ្ងៃបញ្ចប់ឥណទាន:</td><td id="maturity"></td>
    <td>រយៈពេល:</td><td id="loanTerm"></td>
  </tr>
  <tr>
    <td>វដ្តខ្ចីប្រាក់:</td><td id="loanCycle"></td>
    <td>ឈ្មោះសាខា:</td><td id="branchOK"></td>
    <td>ប្រភេទឥណទាន:</td><td id="productType"></td>
  </tr>
</table>

<!-- Subsection ខ -->
<div class="subsection-title">ខ - ស្ថានភាពបង់ប្រាក់</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>ស្ថានភាព:</td><td id="repaymentStatus"></td></tr>
  <tr><td>មូលហេតុ:</td><td id="repaymentNote"></td></tr>
</table>

<!-- Subsection គ -->
<div class="subsection-title">គ - ឯកសារឥណទាន</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>ស្ថានភាពឯកសារ:</td><td id="docStatus"></td></tr>
  <tr><td>មូលហេតុ:</td><td id="docNote"></td></tr>
</table>
    
<!-- Section II -->
<div class="form-section">II. ការចុះត្រួតពិនិត្យផ្ទាល់ (Physical Inspection on site visit)</div>

<!-- Subsection ក -->
<div class="subsection-title">ក - ព័ត៌មានមុខរបរ</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>មុខរបរពេលខ្ចី:</td><td id="businessOld"></td></tr>
  <tr><td>មុខរបរបច្ចុប្បន្ន:</td><td id="businessNow"></td></tr>
  <tr><td>ស្ថានភាពជំនួញ:</td><td id="businessStatus"></td></tr>
  <tr><td>បញ្ជាក់បន្ថែម:</td><td id="businessNote"></td></tr>
</table>

<!-- Subsection ខ -->
<div class="subsection-title">ខ - ព័ត៌មានទ្រព្យធានា</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>ប្រភេទទ្រព្យ:</td><td id="collateralType"></td></tr>
  <tr><td>ស្ថានភាពទ្រព្យ:</td><td id="collateralStatus"></td></tr>
  <tr><td>តម្លៃទ្រព្យធានា:</td><td id="collateralValue"></td></tr>
  <tr><td>*មូលហេតុ:</td><td id="collateralNote"></td></tr>
</table>

<!-- Subsection គ -->
<div class="subsection-title">គ - សញ្ញាណហានិភ័យ</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>គោលបំណងប្រើប្រាស់:</td><td id="usagePurpose"></td></tr>
  <tr><td>*បញ្ជាក់បន្ថែម:</td><td id="usageNote"></td></tr>
  <tr><td>ប្រភពសំណង:</td><td id="repaymentSource"></td></tr>
  <tr><td>បញ្ជាក់បន្ថែម:</td><td id="sourceNote"></td></tr>
</table>

<!-- Subsection ឃ -->
<div class="subsection-title">ឃ - សន្និដ្ឋាន</div>
<table class="white-border-table">
  <colgroup><col style="width: 160px;"><col></colgroup>
  <tr><td>សន្និដ្ឋាន:</td><td id="conclusion"></td></tr>
</table>


<!-- Signature & Check Date Section (merged full width) -->
<div class="full-width-section">
  <div id="checkDate"></div>
  អ្នកចុះត្រួតពិនិត្យ<br>
  ហត្ថលេខា<br><br><br><br>
  <span id="signatureName">......................</span>
</div>
 
</div>

<script>
  async function fetchSpotCheckDataById(id) {
    const token = sessionStorage.getItem("token");
    if (!token) {
      alert("Session expired. Please log in again.");
      window.location.href = "../login.html";
      return;
    }

    try {
      const response = await fetch(`https://secure-backend-tzj9.onrender.com/api/spotcheck/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!response.ok) {
        throw new Error("Failed to fetch SpotCheck data");
      }

      const data = await response.json();
      fillSpotCheckData(data);
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to load SpotCheck data.");
    }
  }

  function formatCheckDate(dateString) {
  if (!dateString) return "";
  const [year, month, day] = dateString.split("-");
  return `ថ្ងៃទី${parseInt(day)} ខែ${month} ឆ្នាំ${year}`;
  }

  function fillSpotCheckData(data) {
  const mapping = {
    customerID: data.LD_CUSTOMER_ID,
    customerName: data.NAME_KHMER,
    loanSize: data.LOAN_SIZE,
    osUSD: data.OS_USD,
    rate: data.RATE,
    ccy: data.CCY,
    disburse: data.DISBURSE,
    maturity: data.MATURITY,
    loanTerm: data.LOAN_TERM,
    loanCycle: data.LOAN_CYCLE,
    branchOK: data.BranchOK,
    productType: data.ProductType,
    repaymentStatus: data.repaymentStatus,
    repaymentNote: data.repaymentNote,
    docStatus: data.docStatus,
    docNote: data.docNote,
    businessOld: data.businessOld,
    businessNow: data.businessNow,
    businessStatus: data.businessStatus,
    businessNote: data.businessNote,
    collateralType: data.collateralType,
    collateralStatus: data.collateralStatus,
    collateralValue: data.collateralValue,
    collateralNote: data.collateralNote,
    usagePurpose: data.usagePurpose,
    usageNote: data.usageNote,
    repaymentSource: data.repaymentSource,
    sourceNote: data.sourceNote,
    conclusion: data.conclusion,
    checkDate: data.checkDate
  };

  // Fill text cells
  for (const [id, value] of Object.entries(mapping)) {
    const el = document.getElementById(id);
if (el) {
  if (id === "checkDate") {
    el.innerText = formatCheckDate(value);
  } else {
    el.innerText = value;
    }
   }
  }
    
  // ✅ Fill the "ត្រួតពិនិត្យវដ្ត" input box
  const cycleInput = document.getElementById("cycleInput");
  if (cycleInput && data.cycle) {
    cycleInput.value = data.cycle;
  }

  // ✅ Fill signature name from logged in user
  const user = JSON.parse(sessionStorage.getItem("loggedInUser") || "{}");
  const signatureEl = document.getElementById("signatureName");
  if (signatureEl && user.fullname) {
    signatureEl.innerText = user.fullname;
  }
}


  // Run on page load
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      alert("Invalid URL. No ID found.");
      return;
    }

    fetchSpotCheckDataById(id);
  });

  // Close button logic
  document.getElementById("closeBtn").addEventListener("click", () => {
  window.location.href = "./reportSpotcheck.html";
});
  
</script> 
</body>
</html>
